name: Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'images/**'
      - 'documents/**'

permissions:
  contents: write
  packages: write
  discussions: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.release.outputs.version }}
      release_id: ${{ steps.release.outputs.release_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build installers
        run: npm run make
        env:
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          WIN_CERTIFICATE_PASSWORD: ${{ secrets.WIN_CERTIFICATE_PASSWORD }}

      - name: Get version info
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v3
        with:
          ignorePreReleases: false
          github_token: ${{ github.token }}

      - name: Create or update release
        id: release
        uses: actions/github-script@v7
        with:
          script: |
            const { data: release } = await github.rest.repos.getLatestRelease({
              owner: context.repo.owner,
              repo: context.repo.repo
            }).catch(() => ({ data: null }));

            const version = '${{ steps.version.outputs.version }}';
            const changelog = `${{ steps.changelog.outputs.changelog }}`;

            const releaseBody = `## What's Changed

${changelog}

---

## Download

Download the installer for your platform:
- [Windows (.exe)](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/download/v${version}/iScrcpy-win-setup-${version}.exe)
- [macOS (.dmg)](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/download/v${version}/iScrcpy-mac-${version}.dmg)
- [Linux (.deb)](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/download/v${version}/iScrcpy-linux-${version}.deb)
`;

            if (release && release.tag_name === `v${version}`) {
              // Update existing release
              await github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id,
                body: releaseBody,
                draft: false,
                prerelease: false
              });
              console.log('Release updated successfully');
              return { version, release_id: release.id };
            } else {
              // Create new release
              const newRelease = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: `v${version}`,
                name: `iScrcpy v${version}`,
                body: releaseBody,
                draft: false,
                prerelease: false
              });
              console.log('Release created successfully');
              return { version, release_id: newRelease.data.id };
            }

      - name: Find and upload release assets
        id: find_assets
        run: |
          # Find all maker outputs
          echo "maker_output=$(ls -d out/make/*/ 2>/dev/null | head -1 || echo '')" >> $GITHUB_OUTPUT

          # List all files in maker directories
          find out/make -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.deb" -o -name "*.rpm" -o -name "*.zip" \) -printf "%p\n" || true

      - name: Upload release asset files
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.release.outputs.release_url }}
          asset_path: out/make
          asset_content_type: application/octet-stream

  notify:
    name: Notify Release
    needs: release
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Create release discussion
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.release.outputs.version }}';
            const releaseId = ${{ needs.release.outputs.release_id }};

            await github.rest.repos.createReleaseDiscussion({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId,
              body: {
                discussion_category: "General",
                body: `ðŸš€ **iScrcpy v${version} Released!**\n\nA new version has been released. Check out the [release notes](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/v${version}) for details.`
              }
            });
